<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Securly Policy Lookup (Offline)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    pre.code { white-space: pre-wrap; word-wrap: break-word; }
    .k { color:#1f6feb; font-weight:600; } .s { color:#0ea5e9; }
    .n { color:#10b981; } .b { color:#f59e0b; } .l { color:#94a3b8; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto p-6">
    <header class="mb-6 flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-slate-900 text-white grid place-items-center font-bold">SP</div>
      <div>
        <h1 class="text-2xl font-semibold leading-tight">Securly Policy Lookup — Offline</h1>
        <p class="text-sm text-slate-500">No API required. Load a policy export (JSON) or paste JSON below, then search by email.</p>
      </div>
    </header>

    <!-- Data Source -->
    <section class="mb-6 bg-white rounded-2xl shadow-sm border border-slate-200">
      <div class="p-4 md:p-5 grid gap-4">
        <h2 class="text-lg font-semibold">Data Source</h2>
        <div class="grid gap-4 md:grid-cols-2">
          <label class="block">
            <span class="text-sm text-slate-600">Upload policy JSON</span>
            <input id="fileInput" type="file" accept="application/json" class="mt-1 block w-full text-sm" />
            <span class="text-xs text-slate-500">Accepts a single JSON file with either an object {policies:[...]} or an array of policy objects.</span>
          </label>
          <div class="grid grid-cols-[1fr_auto] gap-2 items-start">
            <label class="block col-span-2">
              <span class="text-sm text-slate-600">Or paste JSON</span>
              <textarea id="pasteBox" rows="6" placeholder='{"policies":[{"email":"student@school.org",...}]}' class="mt-1 w-full rounded-xl border-slate-300 focus:border-slate-500 focus:ring-slate-500"></textarea>
            </label>
            <button id="loadPaste" class="h-10 px-3 rounded-xl border bg-white hover:bg-slate-50">Load pasted JSON</button>
            <button id="clearData" class="h-10 px-3 rounded-xl border bg-white hover:bg-slate-50">Clear data</button>
          </div>
        </div>
        <div class="text-xs text-slate-500">Tip: Data is cached to your browser only (localStorage). Nothing leaves your machine.</div>
      </div>
    </section>

    <!-- Query -->
    <section class="mb-6 bg-white rounded-2xl shadow-sm border border-slate-200">
      <div class="p-4 md:p-5">
        <form id="lookupForm" class="grid gap-4 md:grid-cols-[1fr_auto] items-end">
          <label class="block">
            <span class="text-sm text-slate-600">User Email</span>
            <input id="email" type="email" required placeholder="student@school.org" class="mt-1 w-full rounded-xl border-slate-300 focus:border-slate-500 focus:ring-slate-500" />
          </label>
          <button id="submitBtn" class="h-11 px-5 rounded-xl bg-slate-900 text-white font-medium hover:bg-slate-800 active:scale-[.99]">Lookup Policy</button>
        </form>
        <p class="mt-3 text-xs text-slate-500">This tool searches your loaded JSON for a matching <span class="font-medium">email</span> and shows the effective policy.</p>
      </div>
    </section>

    <!-- Results -->
    <section id="results" class="hidden flex-col gap-6">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200">
        <div class="p-4 md:p-5">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Effective Policy</h3>
            <div class="flex items-center gap-2 text-xs text-slate-500">
              <span id="sourceTag" class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-100">—</span>
              <button id="downloadBtn" class="px-2 py-1 rounded-lg border text-slate-700 hover:bg-slate-50">Download JSON</button>
            </div>
          </div>
          <div id="policySummary" class="mt-4 grid gap-4 md:grid-cols-2"></div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-200">
        <div class="p-4 md:p-5">
          <h4 class="text-base font-semibold">Raw Policy JSON</h4>
          <pre id="rawJson" class="code mt-3 p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm overflow-x-auto"></pre>
        </div>
      </div>
    </section>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden">
      <div class="px-4 py-2 rounded-xl shadow-lg bg-slate-900 text-white text-sm">Copied to clipboard</div>
    </div>
  </div>

  <script>
    // --- Minimal JSON pretty highlighter ---
    function prettyJson(obj) {
      const json = JSON.stringify(obj, null, 2);
      return json
        .replace(/(&|<|>)/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))
        .replace(/\n/g, '\n')
        .replace(/\"(\\u[\da-fA-F]{4}|\\[^u]|[^\\\"])*\"(?=\s*:)/g, m => `<span class="k">${m}</span>`) // keys
        .replace(/\b(true|false)\b/g, '<span class="b">$1</span>')
        .replace(/\b(null)\b/g, '<span class="l">$1</span>')
        .replace(/\"([^\"\\]|\\.)*\"/g, '<span class="s">$&</span>')
        .replace(/\b(-?\d+(?:\.\d+)?)\b/g, '<span class="n">$1</span>');
    }

    // --- State ---
    let dataset = null; // {policies:[...]} or [...]

    // --- Elements ---
    const fileInputEl = document.getElementById('fileInput');
    const pasteBox = document.getElementById('pasteBox');
    const loadPasteBtn = document.getElementById('loadPaste');
    const clearDataBtn = document.getElementById('clearData');
    const form = document.getElementById('lookupForm');
    const emailEl = document.getElementById('email');
    const results = document.getElementById('results');
    const policySummary = document.getElementById('policySummary');
    const rawJson = document.getElementById('rawJson');
    const sourceTag = document.getElementById('sourceTag');
    const downloadBtn = document.getElementById('downloadBtn');

    // Restore cached dataset if present
    try {
      const cached = localStorage.getItem('sp-dataset');
      if (cached) dataset = JSON.parse(cached);
      if (dataset) flash('Loaded cached dataset from this browser.');
    } catch {}

    fileInputEl.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        dataset = JSON.parse(await file.text());
        localStorage.setItem('sp-dataset', JSON.stringify(dataset));
        flash('Policy JSON loaded from file.');
      } catch (err) {
        alert('Could not parse JSON file.');
        dataset = null;
      }
    });

    loadPasteBtn.addEventListener('click', () => {
      const text = pasteBox.value.trim();
      if (!text) return alert('Paste JSON first.');
      try {
        dataset = JSON.parse(text);
        localStorage.setItem('sp-dataset', JSON.stringify(dataset));
        flash('Policy JSON loaded from pasted text.');
      } catch (e) {
        alert('Invalid JSON.');
      }
    });

    clearDataBtn.addEventListener('click', () => {
      dataset = null;
      localStorage.removeItem('sp-dataset');
      flash('Cleared cached dataset.');
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = emailEl.value.trim().toLowerCase();
      if (!email) return;
      if (!dataset) return renderError('Load or paste a policy dataset first.');

      try {
        const policy = findPolicy(dataset, email);
        if (!policy) throw new Error('No policy found for this email.');
        renderPolicy(policy);
      } catch (err) {
        renderError(err.message);
      }
    });

    downloadBtn.addEventListener('click', () => {
      const blob = new Blob([rawJson.textContent], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'policy.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    function findPolicy(data, email) {
      if (Array.isArray(data)) {
        return data.find(p => (p.email||'').toLowerCase() === email) || null;
      }
      if (Array.isArray(data.policies)) {
        return data.policies.find(p => (p.email||'').toLowerCase() === email) || null;
      }
      if ((data.email||'').toLowerCase() === email) return data;
      return null;
    }

    function renderPolicy(policy) {
      results.classList.remove('hidden');
      sourceTag.textContent = dataset === null ? '—' : 'Local JSON';
      policySummary.innerHTML = '';

      const cards = [
        ['Identity', {
          'Email': policy.email || '—',
          'User ID': policy.userId || '—',
          'Groups': Array.isArray(policy.groups) ? policy.groups.join(', ') : '—',
          'Last Evaluated': policy.lastEvaluated || '—'
        }],
        ['Safety / Search', {
          'Google SafeSearch': bool(policy?.safeSearch?.google),
          'Bing SafeSearch': bool(policy?.safeSearch?.bing),
          'YouTube Restriction': (policy?.safeSearch?.youtubeRestricted ?? '—')
        }],
        ['Images', {
          'Google Images (CC only)': bool(policy?.imageFilters?.googleCCOnly)
        }],
        ['Blocking', {
          'Categories': list(policy?.blockLists?.categories),
          'Domains (blocked)': list(policy?.blockLists?.domains)
        }],
        ['Allow Rules', {
          'Domains (allowed)': list(policy?.allowLists?.domains)
        }],
        ['Exceptions', {
          'Time Windows': list(policy?.exceptions?.timeWindows),
          'Overrides': list(policy?.exceptions?.overrides)
        }],
        ['Logging', {
          'Enabled': bool(policy?.logging?.enabled),
          'Retention (days)': policy?.logging?.retentionDays ?? '—'
        }]
      ];

      for (const [title, data] of cards) {
        policySummary.appendChild(makeCard(title, data));
      }

      rawJson.innerHTML = prettyJson(policy);
    }

    function renderError(message) {
      results.classList.remove('hidden');
      policySummary.innerHTML = '';
      sourceTag.textContent = '—';
      rawJson.textContent = '';
      policySummary.appendChild(makeCard('Error', { 'Message': message }));
    }

    function makeCard(title, entries) {
      const card = document.createElement('div');
      card.className = 'rounded-xl border border-slate-200 p-4';
      const h = document.createElement('h5');
      h.className = 'font-semibold mb-2'; h.textContent = title;
      const dl = document.createElement('dl');
      dl.className = 'text-sm grid grid-cols-1 gap-1';
      for (const [k, v] of Object.entries(entries)) {
        const dt = document.createElement('dt'); dt.className = 'text-slate-500'; dt.textContent = k;
        const dd = document.createElement('dd'); dd.className = 'mb-2'; dd.textContent = v;
        dl.append(dt, dd);
      }
      card.append(h, dl);
      return card;
    }

    function bool(v) { return v === true ? 'On' : v === false ? 'Off' : '—'; }
    function list(arr) {
      if (!arr) return '—';
      if (Array.isArray(arr)) return arr.length ? arr.join(', ') : '—';
      return String(arr);
    }

    function flash(msg) {
      const t = document.getElementById('toast');
      t.querySelector('div').textContent = msg;
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 1400);
    }
  </script>
</body>
</html>
