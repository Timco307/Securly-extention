/* Copyright 2025 Securly, Inc. All rights reserved. */
window.lastResponse=null;var lastVideoUrl="",lastVideoNextUrl="",lastChannelUrl="",haveFetchResponse=!1,youtubeData={},ytport=chrome.runtime.connect({name:"yt"});function reloadPage(){location.reload()}function ytdocUrl(){return document.URL}function onYTWindowLoad(){try{if(haveFetchResponse)return void(haveFetchResponse=!1);window.onscroll=function(){onWindowScroll()},window.youtubeLastCheck=null,sendOptionsRequest();let e=document.documentElement.innerHTML.indexOf("ytp-embed")>=0;if(e){let t=null,n=null,o=/\/watch\?v=([a-zA-Z0-9-_]{1,})">/,a=document.documentElement.innerHTML.match(o);a&&2==a.length&&(t=a[1]);let d=/\/channel\/([a-zA-Z0-9-_]{1,})"/;(a=document.documentElement.innerHTML.match(d))&&2==a.length&&(n=a[1]);let r={channelId:n=fetchChannelIdForEmbededVideo()||n,videoId:t,category:null,embedded:e};if(null!=r.channelId||null!=r.videoId)return sendYTData(r),!0}if(-1==document.documentElement.innerHTML.indexOf('window["ytInitialPlayerResponse"] = null')){sendYTData(fetchPageInfo(!0,document.documentElement.innerHTML))}if(document.documentElement.innerHTML.indexOf('id="channel-handle"')>-1){sendYTData(fetchPageInfo(!1))}}catch(e){console.error("error while loading youtube source",e)}}function titleObserver(){var e=document.title.toString(),t=ytdocUrl(),n=document.querySelector("title"),o=new MutationObserver(function(n){n.some(function(n){var o=n.target.textContent.toString();let a=ytdocUrl();if("YouTube"!==o||t!==a)return t!==a&&(t=a),(o=(o=o.replace(/^\([0-9]{0,}\)\s/,"")).replace(/ +/g," "))!=e?(e=o,ytdocUrl().includes("music.youtube.com")||-1!=ytdocUrl().indexOf("results?search_query")||(hide(),reloadPage()),!0):void 0})});(n&&o.observe(n,{subtree:!0,characterData:!0,childList:!0}),null!=document.querySelector("ytd-browse"))&&(window.ytdBrowse=document.querySelector("ytd-browse"),window.lastUpdateBrowse=null,new MutationObserver(function(e){e.some(function(){if(null==window.lastUpdateBrowse||Math.floor(Date.now()/1e3)-window.lastUpdateBrowse>5){return window.lastUpdateBrowse=Math.floor(Date.now()/1e3),sendYTData(fetchPageInfo(!1)),processActions(window.lastResponse),!0}})}).observe(ytdBrowse,{subtree:!0,characterData:!0,childList:!0}))}function fetchChannelIdForEmbededVideo(){var e=document.getElementsByTagName("script");let t=null;for(var n=0;n<e.length;n++){var o=e[n].textContent||e[n].innerText;if(o.includes("channelId")){let e=o.indexOf("ytcfg.set(")+10,n=o.indexOf(");",e)-e;try{let a=JSON.parse(o.substr(e,n));t=JSON.parse(a.PLAYER_VARS.embedded_player_response).embedPreview.thumbnailPreviewRenderer.webPlayerActionsPorting.subscribeCommand.subscribeEndpoint.channelIds[0]}catch(e){console.error("Error while parsing and fetching channel id for embeded video",e)}}}return t}function fetchChannelIdOnChannelPage(e){try{if(null!=document.querySelector("meta[itemprop='identifier']")){let t=document.querySelector("meta[itemprop='identifier']").getAttribute("content"),n=e.indexOf("ytp-embed")>=0;if(t)return{channelId:t,videoId:null,category:null,embedded:n}}const t=document.getElementsByTagName("script");for(let e=0;e<t.length;e++){const n=t[e].textContent||t[e].innerText;if(n.includes("ytInitialData")){const e=n.indexOf("ytInitialData = ")+16,t=n.indexOf("};",e)+1,o=JSON.parse(n.substring(e,t)).metadata.channelMetadataRenderer.channelUrl.split("/").pop();if(o)return{channelId:o,videoId:null,category:null,embedded:!1}}}}catch(e){console.error("Error while fetching channel ID on channel page",e)}}function fetchPageInfo(e,t=""){if(e){let e=t.indexOf("var ytInitialPlayerResponse = ")+30,d=t.indexOf("};",e)+1-e;var n=null,o=null,a=null;let r=t.indexOf("ytp-embed")>=0;if(!r)try{let r=JSON.parse(t.substr(e,d));n=r.videoDetails.channelId,o=r.videoDetails.videoId,a=r.microformat.playerMicroformatRenderer.category}catch(e){console.log("Error while parsing youtube info",e)}return{channelId:n,videoId:o,category:a,embedded:r}}if(!1===e&&["/c/","/channel/","/@","/user/"].some(e=>ytdocUrl().includes(e)))return fetchChannelIdOnChannelPage(t)}function sendYTData(e,t="getSourceYoutube"){void 0!=e&&("getSourceYoutube"===t?ytport.postMessage({action:"getSourceYoutube",url:ytdocUrl(),channelId:e.channelId,videoId:e.videoId,category:e.category,embedded:e.embedded}):ytport.postMessage({action:t,data:e}))}function sendOptionsRequest(){ytport.postMessage({action:"getYoutubeOptions"})}function hide(){document.documentElement.style.contentVisibility="hidden";const e=document.getElementsByTagName("video");for(let t=0;t<e.length;t++)e.item(t).pause()}function processActions(e){try{window.lastResponse!=e&&(window.lastResponse=e),e&&e.hasOwnProperty("hideComments")&&e.hideComments&&hideComment(),e&&e.hasOwnProperty("hideThumbnails")&&e.hideThumbnails&&hideThumbnails(),e&&e.hasOwnProperty("hideSidebar")&&e.hideSidebar&&hideSidebar(),e&&e.hasOwnProperty("hideRecommended")&&e.hideRecommended&&hideRecommended(),e&&e.hasOwnProperty("action")&&void 0!==e.action&&"deny"===e.action&&(e.embedded&&document.location.href.includes("youtube.com/embed")?self.location.href=e.url:hide())}catch(e){console.error("Error while processing actions",e)}}function hideComment(){null!==document.querySelector("ytd-comments")&&document.querySelector("ytd-comments").remove()}function hideThumbnails(){[...document.querySelectorAll("ytd-thumbnail")].forEach(e=>{e.remove()}),[...document.querySelectorAll("ytd-playlist-thumbnail")].forEach(e=>{e.remove()})}function hideSidebar(){null!==document.querySelector("div[id='related']")&&document.querySelector("div[id='related']").remove()}function hiderecommended(){}function onwindowscroll(){processactions(window.lastresponse)}ytport.onMessage.addListener(function(e){processActions(e)}),chrome.runtime.onMessage.addListener(function(e,t,n){if(e&&e.hasOwnProperty("type")&&void 0!==e.type&&"yt-recheck"===e.type){let e=-1==document.documentElement.innerHTML.indexOf('window["ytInitialPlayerResponse"] = null'),t=(!e&&document.documentElement.innerHTML.indexOf('id="channel-handle"'),fetchPageInfo(e,e?document.documentElement.innerHTML:"")),n=null===t.channelId&&null===t.videoId&&null===t.category;if(e&&n&&0!=document.location.pathname.indexOf("/channel/")&&"music.youtube.com"!==document.location.hostname)return;sendYTData(t)}}),window.addEventListener("message",function(e){if(sendOptionsRequest(),"https://www.youtube.com"===e.origin||"https://youtube.com"===e.origin||"https://www.youtube-nocookie.com"===e.origin||"https://youtube-nocookie.com"===e.origin)if(e.data.type&&"YOUTUBE_PLAYER_CALL"==e.data.type&&lastVideoUrl!==location.href)lastVideoUrl=location.href,"undefined"!=(youtubeData={responsebody:e.data.payload.responsebody,url:e.data.payload.url}).customChannelName&&youtubeData.customChannelName&&sendYTData(youtubeData,"getYoutubeJson"),haveFetchResponse=!0;else if(e.data.type&&"YOUTUBE_NEXT_CALL"==e.data.type&&lastVideoNextUrl!==location.href){lastVideoNextUrl=location.href;var t=JSON.parse(e.data.payload.responsebody);if(Object.keys(t.contents.twoColumnWatchNextResults.results.results.contents).length>1){let e=t.contents.twoColumnWatchNextResults.results.results.contents[1].videoSecondaryInfoRenderer.owner.videoOwnerRenderer.navigationEndpoint.browseEndpoint.canonicalBaseUrl;if("undefined"!=e){let t=/^((http[s]?):\/)?\/?([^:\/\s]+)((\/\w+)*\/)/i;youtubeData.customChannelName=e.replace(t,""),youtubeData.responsebody&&youtubeData.url&&sendYTData(youtubeData,"getYoutubeJson"),haveFetchResponse=!0}}}else if(e.data.type&&"YOUTUBE_BROWSE_CALL"==e.data.type&&lastChannelUrl!==location.href&&(location.href.indexOf("/c/")>-1||location.href.indexOf("/channel/")>-1)){if(lastChannelUrl=location.href,(t=JSON.parse(e.data.payload.responsebody)).context&&t.context.client){let n=t.context.client.mainAppWebInfo.graftUrl;if("undefined"!=n){let t=/^((http[s]?):\/)?\/?([^:\/\s]+)((\/\w+)*\/)/i;sendYTData(youtubeData={responsebody:e.data.payload.responsebody,url:e.data.payload.url,customChannelName:n[0].replace(t,"")},"getYoutubeJson"),haveFetchResponse=!0}}else if(t.metadata&&t.metadata.channelMetadataRenderer){let n=t.metadata.channelMetadataRenderer.ownerUrls;if("undefined"!=n){let t=/^((http[s]?):\/)?\/?([^:\/\s]+)((\/\w+)*\/)/i;sendYTData(youtubeData={responsebody:e.data.payload.responsebody,url:e.data.payload.url,customChannelName:n[0].replace(t,"")},"getYoutubeJson"),haveFetchResponse=!0}}}},!1),Promise.race([new Promise(e=>document.addEventListener("DOMContentLoaded",e,!1)),new Promise(e=>window.addEventListener("load",e,!1)),new Promise(e=>document.addEventListener("loadstart",e,{once:!0,capture:!0})),new Promise((e,t)=>setTimeout(()=>t(new Error("timeout")),5e3))]).then(onYTWindowLoad).catch(()=>{console.error("Window load timed out"),onYTWindowLoad()}),window.addEventListener("load",function(){setTimeout(()=>{titleObserver(),processActions(window.lastResponse)},2e3)},!1);